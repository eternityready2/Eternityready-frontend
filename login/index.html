<head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./login.css" />
    <link rel="stylesheet" href="/lib/toast.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <main>
        <div id="left">
          <a href="/new-homepage">
            <img
                src="./public/logo.png"
            />
          </a>
            <h1>Sign in</h1>
            <form id = "login">
                <section>
                    <label for="email">Email</label>
                    <input
                        type="text"
                        id="email"
                        name="email"
                        placeholder="Type your email"
                        required
                    />
                </section>
                <section>
                    <label for="password">Password</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        placeholder="Type your password"
                        required
                    />
                </section>
                <section id="check-and-forgot-password">
                    <div>
                        <input type="checkbox" id="remember-me" name="remember-me" value="0">
                        <label for="remember-me">Remember me</label><br>
                    </div>
                    <a href="/forgot-password">Forgot password?</a>
                </section>
                <button type="submit">Log In</button>
            </form>
            <p> Don't have an account? <a href="/register">Sign Up!</a> </p>
        </div>
        <div id="right">
            <img src="./public/media.jpg"/>
        </div>
    </main>
    <script src="/lib/constants.js"></script>
    <script src="/lib/session.js"></script>
    <script src="/lib/toast.js"></script>
    <script>
        const form = document.getElementById('login');
        form.addEventListener('submit', async (event) => {
          event.preventDefault();

          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          const query = `
            mutation Login($email: String!, $password: String!) {
              authenticateUserWithPassword(email: $email, password: $password) {
                ... on UserAuthenticationWithPasswordSuccess {
                  sessionToken
                  item {
                    id
                    email
                    privilege
                  }
                }
                ... on UserAuthenticationWithPasswordFailure {
                  message
                }
              }
            }
          `;
          const variables = { email, password };

          try {
            const response = await fetch(`${API_BASE_URL}/api/graphql`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query, variables }),
            });

            const result = await response.json();

            if (result.errors) {
              console.error('Error login user:', result.errors);
              addToastAndRemoveLast(
                "Error", result.errors[0].message, "error"
              );
            } else {
              const authResult = result.data.authenticateUserWithPassword;
              console.log(authResult);
              if (authResult.item) {
                addToastAndRemoveLast(
                  "Success",
                  `Logged In successfully: ${authResult.item.email}. Redirecting...`,
                  "success"
                );
                setSession(authResult.sessionToken)
                window.location.assign(`${ETERNITY_BASE_URL}/new-homepage`);

              } else if (authResult.message) {
                addToastAndRemoveLast(
                  "Error", authResult.message, "error"
                );

              } else {
                addToastAndRemoveLast(
                  "Error", "Unexpected login response", "error"
                );
              }
            }
          } catch (error) {
            console.error('Network error:', error);
            addToastAndRemoveLast(
              "Error", error.message, "error"
            );
          }
        });
    </script>
</body>
