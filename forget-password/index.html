<head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./forget-password.css" />
    <link rel="stylesheet" href="/lib/toast.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <main>
        <div id="left">
            <img
                src="./public/logo.png"
            />
            <h1>Reset your password</h1>
            <p>Answer these questions correctly to be able to reset your password</p>
            <form id="forget-password">
                <section>
                  <label for="email">Email</label>
                  <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="Your email"
                      required
                  />
                </section>
                <section>
                  <label for="password">Password</label>
                  <input
                      type="password"
                      id="password"
                      name="password"
                      placeholder="Your password"
                      required
                  />
                </section>
                <button type="submit">Submit</button>
            </form>
        </div>
        <div id="right">
            <img src="./public/media.jpg"/>
        </div>
    </main>
    <script src="/lib/constants.js"></script>
    <script src="/lib/session.js"></script>
    <script src="/lib/toast.js"></script>
    <script>
      async function loadSecurityQuestions() {
        const query = `
          query {
            securityQuestions {
              id
              question
            }
          }
        `;

        try {
          const response = await fetch(`${API_BASE_URL}/api/graphql`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query }),
          });

          const result = await response.json();

          if (result.errors) {
            console.error('Error getting questions:', result.errors);
            addToastAndRemoveLast(
              "Error", result.errors[0].message, "error"
            );
          } else {
            console.log(result);
            for (let idx = 3; idx > 0; idx--) {
              let section = document.createElement("section");
              let content = `
                <label for="security-question-${idx}">Security question ${idx}</label>
                <select id="security-question-${idx}" autofocus="true" required>
                  <option value="">Please choose an option</option>
              `;
              for (const question of result?.data?.securityQuestions) {
                content += `
                  <option value="${question?.id}">${question?.question}</option>
                `;
              }

              content += "</select>";
              content += `
                <input
                    type="text"
                    id="security-answer-${idx}"
                    placeholder="Answer"
                    required
                />
              `;
              section.innerHTML = content;
              document.getElementById("password").closest("section").insertAdjacentElement(
                "afterEnd", section
              );
            }
          }

        } catch (error) {
          console.error('Network error:', error);
          addToastAndRemoveLast(
            "Error", error.message, "error"
          );
        }
      }
      loadSecurityQuestions();
    </script>
    <script>
      const form = document.getElementById('forget-password');
      form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          const securityQuestions = [
            {
              questionId: document.getElementById('security-question-1')?.value,
              answer: document.getElementById('security-answer-1')?.value
            },
            {
              questionId: document.getElementById('security-question-2')?.value,
              answer: document.getElementById('security-answer-2')?.value
            },
            {
              questionId: document.getElementById('security-question-3')?.value,
              answer: document.getElementById('security-answer-3')?.value
            },
          ];

          try {
            const response = await fetch(`${API_BASE_URL}/api/password-reset`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email,
                newPassword: password,
                security: securityQuestions
              }),
            });

            const result = await response.json();

            if (!response.ok) {
              addToastAndRemoveLast(
                "Error",
                result.error || "Failed to reset password",
                "error"
              );
            } else {
              addToastAndRemoveLast(
                "Success",
                "Password reset successful! You may now log in.",
                "success"
              );
              window.location.assign(`${ETERNITY_BASE_URL}/login`);
            }
          } catch (error) {
            console.error("Network error:", error);
            addToastAndRemoveLast(
              "Error", error.message, "error"
            );
          }
        });
  </script>
</body>
