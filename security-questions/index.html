<head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./security-questions.css" />
    <link rel="stylesheet" href="/lib/toast.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <main>
        <div id="left">
            <img
                src="./public/logo.png"
            />
            <h1>In case you forgot your password</h1>
            <form id="security-questions">
                <button type="submit">Submit</button>
            </form>
        </div>
        <div id="right">
            <img src="./public/media.jpg"/>
        </div>
    </main>
    <script src="/lib/session.js"></script>
    <script src="/lib/toast.js"></script>
    <script>
      async function loadSecurityQuestions() {
        const query = `
          query GetUserAnswers($userId: ID!) {
            securityAnswers(where: { user: { id: { equals: $userId } } }) {
              id
              answer
              createdAt
              question {
                id
                question
              }
            }
            securityQuestions {
              id
              question
            }
          }
        `;

        const userId = await getUserIdFromSessionToken(getSession());
        const variables = { userId };

        try {
          const response = await fetch('http://api.eternityready.com/api/graphql', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query, variables }),
          });

          const result = await response.json();
          if (result.errors) {
            console.error('Error getting questions:', result.errors);
            addToastAndRemoveLast(
              "Error", result.errors[0].message, "error"
            );
          } else {
            const { securityQuestions, securityAnswers } = result.data;

            // Step 1: Find the latest answer per question by timestamp
            const latestAnswerMap = new Map();

            for (const ans of securityAnswers) {
              const qId = ans.question.id;
              const currentLatest = latestAnswerMap.get(qId);

              if (
                !currentLatest ||
                new Date(ans.createdAt) > new Date(currentLatest.createdAt)
              ) {
                latestAnswerMap.set(qId, ans);
              }
            }

            // Step 2: Map questions to include latest user answer or null if none
            const questionsWithAnswers = securityQuestions.map((q) => ({
              ...q,
              userAnswer: latestAnswerMap.get(q.id) || null,
            }));

            // Step 3: Sort questions so those with answers come first
            questionsWithAnswers.sort((a, b) => {
            const aHasAnswer = a.userAnswer !== null;
            const bHasAnswer = b.userAnswer !== null;

            if (aHasAnswer && bHasAnswer) {
              return new Date(b.userAnswer.createdAt) - new Date(a.userAnswer.createdAt);
            } else if (aHasAnswer) {
              return -1;
            } else if (bHasAnswer) {
              return 1;
            } else {
              return 0;
            }
          });
            console.log(questionsWithAnswers);
            for (let idx = 3; idx > 0; idx--) {
              let section = document.createElement("section");
              let content = `
                <label for="security-question-${idx}">Security question ${idx}</label>
                <select id="security-question-${idx}" autofocus="true" required>
                  <option value="">Please choose an option</option>
              `;
              for (const data of questionsWithAnswers) {
                content += `
                  <option ${data?.id == questionsWithAnswers[idx-1]?.id ? "selected" : ''} value="${data?.id}">${data?.question}</option>
                `;
              }

              content += "</select>";
              content += `
                <input
                    type="text"
                    id="security-answer-${idx}"
                    placeholder="Answer"
                    value="${questionsWithAnswers[idx-1]?.userAnswer?.answer ?? ""}"
                    required
                />
              `;
              section.innerHTML = content;
              document.getElementById("security-questions").insertAdjacentElement(
                "afterbegin", section
              );
            }
          }

        } catch (error) {
          console.error('Network error:', error);
          addToastAndRemoveLast(
            "Error", error.message, "error"
          );
        }
      }
      loadSecurityQuestions();
    </script>
    <script>
      const form = document.getElementById('security-questions');

      
      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const sessionToken = getSession();

        if (!sessionToken) {
          addToastAndRemoveLast(
            "Error",
            'User not authenticated. Please log in.',
            "error"
          );
          return;
        }

        const userId = await getUserIdFromSessionToken(sessionToken);

        if (!userId) {
          addToastAndRemoveLast(
            "Error",
            'Failed to get user ID from session. Please log in again.',
            "error"
          );
          return;
        }

        const securityQuestion1 = document.getElementById('security-question-1').value;
        const securityAnswer1 = document.getElementById('security-answer-1').value;
        const securityQuestion2 = document.getElementById('security-question-2').value;
        const securityAnswer2 = document.getElementById('security-answer-2').value;
        const securityQuestion3 = document.getElementById('security-question-3').value;
        const securityAnswer3 = document.getElementById('security-answer-3').value;


        const mutation = `
          mutation SaveSecurityAnswers($answers: [SecurityAnswerCreateInput!]!) {
            createSecurityAnswers(data: $answers) {
              id
            }
          }
        `;

        const variables = {
          answers: [
            {
              answer: securityAnswer1,
              question: { connect: { id: securityQuestion1 } },
              user: { connect: { id: userId } },
            },
            {
              answer: securityAnswer2,
              question: { connect: { id: securityQuestion2 } },
              user: { connect: { id: userId } },
            },
            {
              answer: securityAnswer3,
              question: { connect: { id: securityQuestion3 } },
              user: { connect: { id: userId } },
            },
          ],
        };

        try {
          const response = await fetch('http://127.0.0.1:3000/api/graphql', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`,
            },
            body: JSON.stringify({ query: mutation, variables }),
          });

          const result = await response.json();

          if (result.errors) {
            console.error('Error saving answers:', result.errors);
            addToastAndRemoveLast(
              "Error",
              result.errors[0].message,
              "error"
            );
          } else {
            addToastAndRemoveLast(
              "Success",
              "Security Answers saved successfully. Redirecting...",
              "success"
            );
            window.location.assign("https://api.eternityready.com/profile");
          }
        } catch (error) {
          console.error('Network error:', error);
          addToastAndRemoveLast(
            "Error",
            error.message,
            "error"
          );
        }
      });
    </script>
</body>
